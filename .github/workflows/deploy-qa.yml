name: Deploy QA Backend
on:
  workflow_dispatch:
    inputs:
      version:
        description: "VersiÃ³n del changeset a desplegar"
        required: true
        default: "latest"

env:
  ACR_NAME: weatherlyacr
  IMAGE_NAME: poc-weather-api-qa

jobs:
  build-and-deploy-qa:
    runs-on: ubuntu-latest
    environment: QA

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_QA }}

      - name: Log in to ACR
        run: az acr login --name $ACR_NAME

      - name: Set IMAGE
        run: |
          IMAGE=$ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.event.inputs.version }}
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: "weatherly-api-qa"
          images: ${{ env.IMAGE }}
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI_QA }}
