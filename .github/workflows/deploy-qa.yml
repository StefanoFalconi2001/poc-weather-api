name: Deploy QA Backend
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'VersiÃ³n del changeset a desplegar'
        required: true
        default: 'latest'

env:
  ACR_NAME: weatherlyrg
  IMAGE_NAME: poc-weather-api-qa

jobs:
  build-and-deploy-qa:
    runs-on: ubuntu-latest
    environment: QA

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: az acr login --name $ACR_NAME

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Build and push Docker image
        run: |
          IMAGE=$ACR_NAME.azurecr.io/$IMAGE_NAME:${{ env.IMAGE_TAG }}
          echo "Building Docker image: $IMAGE"
          docker build -t $IMAGE .
          docker push $IMAGE
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'weatherly-api-qa'
          images: ${{ env.IMAGE }}
          slot-name: 'production'
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI_QA }}
